<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Debugger de Vagas</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
</head>

<body>
  <div id="app">
    <h1>{{count}}</h1>
    <table>
      <thead>
        <tr>
          <th>TÃ³pico</th>
          <th>Mensagem</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(msg, topic) in topics">
          <td>{{topic}}</td>
          <td>{{msg}}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const data = {
      count: 0,
      topics: {
      }
    };
    const app = new Vue({
      el: "#app",
      data
    })

    const url = new URL(window.location.href);
    url.protocol = 'ws://';
    const brokerUrl = url.toString();
    const topicPrefix = 'senai-code-xp-vagas/';
    console.log('attempting connection');
    var client = mqtt.connect(brokerUrl);
    
    function updateCount() {
      let count = 0;
      for (topic in data.topics) {
        const msg = data.topics[topic];
        if (msg) {
          count++;
        }
      }
      data.count = count;
    }

    client.on('connect', () => {
      console.info('MQTT connection successful');
      client.subscribe(topicPrefix + '#');
    });
    client.on('message', (topic, message) => console.info(topic, message.toString()));
    client.on('message', (topic, message) => {
      const msg = message.toString();
      if (msg === '') {
        Vue.delete(data.topics, topic, msg)
      } else {
        Vue.set(data.topics, topic, msg);
      }
      updateCount();
    });
  </script>
</body>

</html>